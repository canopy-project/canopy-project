<!DOCTYPE html>
<html>
<head>
    <title>Canopy - Developer Zone - Cloud Server</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="../../canopy_project.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,700|ABeeZee|Titillium+Web:200,300,400,700' rel='stylesheet' type='text/css'>
    <link href='../../canopy_base.css' rel='stylesheet' type='text/css'>
    <link href='../../canopy_project.css' rel='stylesheet' type='text/css'>
    <link href='../../canopy_project_resp.css' rel='stylesheet' type='text/css'>
    <script type='text/javascript' src='../../3rdparty/shjs/sh_main.min.js'></script>
    <link type='text/css' rel='stylesheet' href='../../3rdparty/shjs/sh_style_greg.css'>
    <link href='hammock-custom.css' rel='stylesheet' type='text/css'>
<script>
function get_scroll_y() {
    return window.pageYOffset || document.body.scrollTop || document.html.scrollTop;
}
function get_element_scroll_y(id) {
    return document.getElementById(id).offsetTop;
}

function update_scroll() {
    var y = get_scroll_y();

        document.getElementById('toc_overview').style.fontWeight = '';document.getElementById('toc_overview').style.backgroundColor = '';document.getElementById('toc_about').style.fontWeight = '';document.getElementById('toc_about').style.backgroundColor = '';document.getElementById('toc_hosting_options').style.fontWeight = '';document.getElementById('toc_hosting_options').style.backgroundColor = '';document.getElementById('toc_installation').style.fontWeight = '';document.getElementById('toc_installation').style.backgroundColor = '';document.getElementById('toc_installing_dependencies').style.fontWeight = '';document.getElementById('toc_installing_dependencies').style.backgroundColor = '';document.getElementById('toc_installing_canopy_server').style.fontWeight = '';document.getElementById('toc_installing_canopy_server').style.backgroundColor = '';document.getElementById('toc_configuring_and_running').style.fontWeight = '';document.getElementById('toc_configuring_and_running').style.backgroundColor = '';document.getElementById('toc_configuration').style.fontWeight = '';document.getElementById('toc_configuration').style.backgroundColor = '';document.getElementById('toc_config_priority').style.fontWeight = '';document.getElementById('toc_config_priority').style.backgroundColor = '';document.getElementById('toc_configuration_settings').style.fontWeight = '';document.getElementById('toc_configuration_settings').style.backgroundColor = '';document.getElementById('toc_config_file_example').style.fontWeight = '';document.getElementById('toc_config_file_example').style.backgroundColor = '';document.getElementById('toc_environment_override_example').style.fontWeight = '';document.getElementById('toc_environment_override_example').style.backgroundColor = '';document.getElementById('toc_command-line_override_example').style.fontWeight = '';document.getElementById('toc_command-line_override_example').style.backgroundColor = '';document.getElementById('toc_checking_the_configuration').style.fontWeight = '';document.getElementById('toc_checking_the_configuration').style.backgroundColor = '';document.getElementById('toc_ssl_setup_-_self-signed_certificate').style.fontWeight = '';document.getElementById('toc_ssl_setup_-_self-signed_certificate').style.backgroundColor = '';document.getElementById('toc_ssl_setup_-_ca-signed_certificate').style.fontWeight = '';document.getElementById('toc_ssl_setup_-_ca-signed_certificate').style.backgroundColor = '';document.getElementById('toc_the_canopy-ops_tool').style.fontWeight = '';document.getElementById('toc_the_canopy-ops_tool').style.backgroundColor = '';
    if (0) {
    }
    
            else if (y + 32 > get_element_scroll_y('the_canopy-ops_tool')) {
                document.getElementById('toc_the_canopy-ops_tool').style.fontWeight = "bold";
                document.getElementById('toc_the_canopy-ops_tool').style.backgroundColor = "#d0d0d0";
            }
            
            else if (y + 32 > get_element_scroll_y('ssl_setup_-_ca-signed_certificate')) {
                document.getElementById('toc_ssl_setup_-_ca-signed_certificate').style.fontWeight = "bold";
                document.getElementById('toc_ssl_setup_-_ca-signed_certificate').style.backgroundColor = "#d0d0d0";
            }
            
            else if (y + 32 > get_element_scroll_y('ssl_setup_-_self-signed_certificate')) {
                document.getElementById('toc_ssl_setup_-_self-signed_certificate').style.fontWeight = "bold";
                document.getElementById('toc_ssl_setup_-_self-signed_certificate').style.backgroundColor = "#d0d0d0";
            }
            
            else if (y + 32 > get_element_scroll_y('checking_the_configuration')) {
                document.getElementById('toc_checking_the_configuration').style.fontWeight = "bold";
                document.getElementById('toc_checking_the_configuration').style.backgroundColor = "#d0d0d0";
            }
            
            else if (y + 32 > get_element_scroll_y('command-line_override_example')) {
                document.getElementById('toc_command-line_override_example').style.fontWeight = "bold";
                document.getElementById('toc_command-line_override_example').style.backgroundColor = "#d0d0d0";
            }
            
            else if (y + 32 > get_element_scroll_y('environment_override_example')) {
                document.getElementById('toc_environment_override_example').style.fontWeight = "bold";
                document.getElementById('toc_environment_override_example').style.backgroundColor = "#d0d0d0";
            }
            
            else if (y + 32 > get_element_scroll_y('config_file_example')) {
                document.getElementById('toc_config_file_example').style.fontWeight = "bold";
                document.getElementById('toc_config_file_example').style.backgroundColor = "#d0d0d0";
            }
            
            else if (y + 32 > get_element_scroll_y('configuration_settings')) {
                document.getElementById('toc_configuration_settings').style.fontWeight = "bold";
                document.getElementById('toc_configuration_settings').style.backgroundColor = "#d0d0d0";
            }
            
            else if (y + 32 > get_element_scroll_y('config_priority')) {
                document.getElementById('toc_config_priority').style.fontWeight = "bold";
                document.getElementById('toc_config_priority').style.backgroundColor = "#d0d0d0";
            }
            
            else if (y + 32 > get_element_scroll_y('configuration')) {
                document.getElementById('toc_configuration').style.fontWeight = "bold";
                document.getElementById('toc_configuration').style.backgroundColor = "#d0d0d0";
            }
            
            else if (y + 32 > get_element_scroll_y('configuring_and_running')) {
                document.getElementById('toc_configuring_and_running').style.fontWeight = "bold";
                document.getElementById('toc_configuring_and_running').style.backgroundColor = "#d0d0d0";
            }
            
            else if (y + 32 > get_element_scroll_y('installing_canopy_server')) {
                document.getElementById('toc_installing_canopy_server').style.fontWeight = "bold";
                document.getElementById('toc_installing_canopy_server').style.backgroundColor = "#d0d0d0";
            }
            
            else if (y + 32 > get_element_scroll_y('installing_dependencies')) {
                document.getElementById('toc_installing_dependencies').style.fontWeight = "bold";
                document.getElementById('toc_installing_dependencies').style.backgroundColor = "#d0d0d0";
            }
            
            else if (y + 32 > get_element_scroll_y('installation')) {
                document.getElementById('toc_installation').style.fontWeight = "bold";
                document.getElementById('toc_installation').style.backgroundColor = "#d0d0d0";
            }
            
            else if (y + 32 > get_element_scroll_y('hosting_options')) {
                document.getElementById('toc_hosting_options').style.fontWeight = "bold";
                document.getElementById('toc_hosting_options').style.backgroundColor = "#d0d0d0";
            }
            
            else if (y + 32 > get_element_scroll_y('about')) {
                document.getElementById('toc_about').style.fontWeight = "bold";
                document.getElementById('toc_about').style.backgroundColor = "#d0d0d0";
            }
            
            else if (y + 32 > get_element_scroll_y('overview')) {
                document.getElementById('toc_overview').style.fontWeight = "bold";
                document.getElementById('toc_overview').style.backgroundColor = "#d0d0d0";
            }
            
}
window.onload = function() {
    window.addEventListener("scroll", update_scroll);
}
</script>

    <script>
    $(function() {
        sh_highlightDocument('../../3rdparty/shjs/', '.min.js');
    });
    </script>
</head>
<!--body onload="sh_highlightDocument('../../3rdparty/shjs/', '.min.js');"-->
<body>
<div class=main-outer>
    <div class='bg-white centered'>
        <script> 
            var RELATIVE_PATH = "../../";
            RenderTopbar("devzone");
        </script>
    </div>

    <div class='bg-lightgray banner-thin centered' >
        <div class='l'>
            <span class='logo-in-text' style='color:#ffffff'>Canopy</span> Server
        </div>
    </div>
</div>
    <div class='hammock-toc-outer'><div class='hammock-toc-title'>Canopy Server</div><div id='toc_overview' class='hammock-toc-chapter'><a href='#overview'>Overview</a></div><div id='toc_about' class='hammock-toc-section'><a href='#about'>About</a></div><div id='toc_hosting_options' class='hammock-toc-section'><a href='#hosting_options'>Hosting Options</a></div><div id='toc_installation' class='hammock-toc-chapter'><a href='#installation'>Installation</a></div><div id='toc_installing_dependencies' class='hammock-toc-section'><a href='#installing_dependencies'>Installing Dependencies</a></div><div id='toc_installing_canopy_server' class='hammock-toc-section'><a href='#installing_canopy_server'>Installing Canopy Server</a></div><div id='toc_configuring_and_running' class='hammock-toc-section'><a href='#configuring_and_running'>Configuring and Running</a></div><div id='toc_configuration' class='hammock-toc-chapter'><a href='#configuration'>Configuration</a></div><div id='toc_config_priority' class='hammock-toc-section'><a href='#config_priority'>Config Priority</a></div><div id='toc_configuration_settings' class='hammock-toc-section'><a href='#configuration_settings'>Configuration Settings</a></div><div id='toc_config_file_example' class='hammock-toc-section'><a href='#config_file_example'>Config File Example</a></div><div id='toc_environment_override_example' class='hammock-toc-section'><a href='#environment_override_example'>Environment Override Example</a></div><div id='toc_command-line_override_example' class='hammock-toc-section'><a href='#command-line_override_example'>Command-line Override Example</a></div><div id='toc_checking_the_configuration' class='hammock-toc-section'><a href='#checking_the_configuration'>Checking the Configuration</a></div><div id='toc_ssl_setup_-_self-signed_certificate' class='hammock-toc-section'><a href='#ssl_setup_-_self-signed_certificate'>SSL Setup - Self-signed Certificate</a></div><div id='toc_ssl_setup_-_ca-signed_certificate' class='hammock-toc-section'><a href='#ssl_setup_-_ca-signed_certificate'>SSL Setup - CA-signed Certificate</a></div><div id='toc_the_canopy-ops_tool' class='hammock-toc-chapter'><a href='#the_canopy-ops_tool'>The canopy-ops Tool</a></div></div>
    <div class=hammock-doc-outer>

            <div class=hammock-chapter-outer>
                <a class=hammock-a-name id=overview name=overview></a>
                <div class=hammock-chapter-title>
                    Overview
                </div>
                <div class=hammock-chapter-contents>
                    
    
        <div class=hammock-section-outer>
            <a class=hammock-a-name id=about name=about></a>
            <div class=hammock-section-title>
                About
            </div>
            <div class=hammock-section-contents>
                
        <p>
            The <b>Canopy Server</b> is an open source server-side program
            written in GoLang.  It serves the <a href="../restapi" target="_blank" >Canopy REST API</a> and Canopy
            Websocket API.  Additionally, it can be configured to serve the
            Canopy Device Manager which provides a convenient web-based
            frontend for developers and system administrators.
        </p>
        <p>
            The <b>Canopy Server</b> has been architected to scale linearly to
            millions of devices with class leading performance, security and
            ease-of-use.
        </p>
    
            </div>
        </div>
    
        <div class=hammock-section-outer>
            <a class=hammock-a-name id=hosting_options name=hosting_options></a>
            <div class=hammock-section-title>
                Hosting Options
            </div>
            <div class=hammock-section-contents>
                
        
        <div class=hammock-subsection-outer>
            <div class=hammock-subsection-title>
                Hosted by Us
            </div>
            <div class=hammock-subsection-contents>
                
            <p>
                The Canopy team operates a large-scale deployment of the Canopy
                Server that you can use to develop and launch your
                cloud-enabled product or service.  Our servers are hosted in a
                world-class datacenter with high
                availability.
                <ul><li>
                        <a href="https://sandbox.canopy.link" target="_blank" >
                        <b>https://sandbox.canopy.link</b></a>: Free deployment for
                        learning Canopy and developing smart products.
                    </li>
                </ul>
                Learn more about our hosted offerings on our <a href="http://canopy.link/services.html" target="_blank" >Services</a> page.
            </p>
        
            </div>
        </div>
        
        <div class=hammock-subsection-outer>
            <div class=hammock-subsection-title>
                Hosted by You
            </div>
            <div class=hammock-subsection-contents>
                
            <p>
                The Canopy Server is completely open source and licensed under
                the highly-permisive Apache v2.0 license.  It is easy to deploy
                your own instance of the server by following the installation
                instructions in this document.
            </p>
        
            </div>
        </div>

    
            </div>
        </div>

                </div>
            </div>


            <div class=hammock-chapter-outer>
                <a class=hammock-a-name id=installation name=installation></a>
                <div class=hammock-chapter-title>
                    Installation
                </div>
                <div class=hammock-chapter-contents>
                    
    <p>
        This section contains instructions for installing the Canopy Server
        from a release package or from source on a fresh Ubuntu 14.04 LTS
        machine.  This may be installed in a public cloud, private cloud, local
        network, or even on your laptop!
    </p>
    
        <div class=hammock-section-outer>
            <a class=hammock-a-name id=installing_dependencies name=installing_dependencies></a>
            <div class=hammock-section-title>
                Installing Dependencies
            </div>
            <div class=hammock-section-contents>
                
        <p>
            Canopy requires Cassandra and Oracle Java 1.7 in order to run.
        </p>
        
        <div class=hammock-subsection-outer>
            <div class=hammock-subsection-title>
                Installing Cassandra
            </div>
            <div class=hammock-subsection-contents>
                
            <p>
                Using the text editor of your choice, edit
                <span class=hammock-icode>/etc/apt/sources.list.d/cassandra.sources.list</span>:
            </p>
            <pre class='hammock-code'>sudo vim /etc/apt/sources.list.d/cassandra.sources.list</pre>
            <p>
                Add the following line:
            </p>
            <pre class='hammock-code'>deb http://debian.datastax.com/community stable main</pre>
            <p>
                Save and exit.  Then run:
            </p>
            <pre class='hammock-code'>curl -L http://debian.datastax.com/debian/repo_key | sudo apt-key add -
sudo apt-get update
sudo apt-get install -y cassandra=2.0.7</pre>
        
            </div>
        </div>

        
        <div class=hammock-subsection-outer>
            <div class=hammock-subsection-title>
                Installing Oracle Java 1.7
            </div>
            <div class=hammock-subsection-contents>
                
            <p>
                Run:
            </p>
            <pre class='hammock-code'>sudo apt-get install -y python-software-properties
sudo add-apt-repository ppa:webupd8team/java</pre>
            <p>
                Press ENTER when prompted.  The run:
            </p>
            <pre class='hammock-code'>sudo apt-get update
sudo apt-get install -y oracle-java7-installer</pre>
            <p>
                When prompted, press ENTER.  Then select "Yes" and press ENTER.
            </p>
        
            </div>
        </div>
    
            </div>
        </div>
    
        <div class=hammock-section-outer>
            <a class=hammock-a-name id=installing_canopy_server name=installing_canopy_server></a>
            <div class=hammock-section-title>
                Installing Canopy Server
            </div>
            <div class=hammock-section-contents>
                
        <p>
            The Canopy Server can be built from source or installed from a
            Debian package.
        </p>
        
        <div class=hammock-subsection-outer>
            <div class=hammock-subsection-title>
                Installing Canopy Server From .deb Package
            </div>
            <div class=hammock-subsection-contents>
                
            <p>
                Download the latest release on our <a href="../release" target="_blank" >Release Package Downloads</a> page.  Look for
                the <span class=hammock-icode>".deb x64 64-bit Binary Package"</span>.
            </p>
            <p>
                In the directory where you downloaded the release package,
                install the Canopy Server with this command (replacing
                XX.YY.ZZ-W with the version number you downloaded):
            </p>
            <pre class='hammock-code'>sudo dpkg -i canopy-server_XX.YY.ZZ-W_amd64.deb</pre>
            <p>
                You can now skip ahead to <a href=#configuring_and_running>C<!---->o<!---->n<!---->f<!---->i<!---->g<!---->u<!---->r<!---->i<!---->n<!---->g<!----> <!---->a<!---->n<!---->d<!----> <!---->R<!---->u<!---->n<!---->n<!---->i<!---->n<!---->g<!----></a>.
            </p>
        
            </div>
        </div>
        
        <div class=hammock-subsection-outer>
            <div class=hammock-subsection-title>
                Building Canopy Server From Source
            </div>
            <div class=hammock-subsection-contents>
                
            <p>
                Alternatively you can build the Canopy Server from source by cloning the
                github repository.  This section walks you through the steps.
            </p>
            <p>
                Install golang:
            </p>
            <pre class='hammock-code'>sudo apt-get install -y golang git make mercurial</pre>
            <p>
                Clone the repository:
            </p>
            <pre class='hammock-code'>git clone https://github.com/canopy-project/canopy-server</pre>
            <p>
                Build the project:
            </p>
            <pre class='hammock-code'>cd canopy-server
make</pre>
            <p>
                You should see this output:
            </p>
            <pre class='hammock-output'>make -C src/canopy go_get_deps
make[1]: Entering directory `/home/ubuntu/canopy-server/src/canopy'
mkdir -p ~/.canopy/golang
GOPATH=$(cd ~/.canopy/golang; pwd):$(cd ../../; pwd) go get code.google.com/p/go.net/websocket
GOPATH=$(cd ~/.canopy/golang; pwd):$(cd ../../; pwd) go get github.com/gocql/gocql
GOPATH=$(cd ~/.canopy/golang; pwd):$(cd ../../; pwd) go get github.com/gorilla/sessions
GOPATH=$(cd ~/.canopy/golang; pwd):$(cd ../../; pwd) go get github.com/gorilla/context
GOPATH=$(cd ~/.canopy/golang; pwd):$(cd ../../; pwd) go get github.com/gorilla/mux
GOPATH=$(cd ~/.canopy/golang; pwd):$(cd ../../; pwd) go get github.com/sendgrid/sendgrid-go
GOPATH=$(cd ~/.canopy/golang; pwd):$(cd ../../; pwd) go get code.google.com/p/go.crypto/bcrypt
make[1]: Leaving directory `/home/ubuntu/canopy-server/src/canopy'
make -C src/canopy all
make[1]: Entering directory `/home/ubuntu/canopy-server/src/canopy'
mkdir -p ~/.canopy/golang
GOPATH=$(cd ~/.canopy/golang; pwd):$(cd ../../; pwd) go build canopy-cloud-service.go canopy_cloud.go canopy_json.go
mkdir -p build/
mv canopy-cloud-service build/
mkdir -p ~/.canopy/golang
GOPATH=$(cd ~/.canopy/golang; pwd):$(cd ../../; pwd) go build canopy_cmd.go
mkdir -p build/
mv canopy_cmd build/canodevtool
make[1]: Leaving directory `/home/ubuntu/canopy-cloud/src/canopy'</pre>
            <p>
                Install it:
            </p>
            <pre class='hammock-code'>sudo make install</pre>
            <p>
                You should see this output:
            </p>

            <pre class='hammock-output'>src/canopy install
make[1]: Entering directory `/home/ubuntu/canopy-cloud/src/canopy'
cp build/canopy-cloud-service build/canodevtool /usr/local/bin
cp ../../scripts/canopy-cloud-service /etc/init.d
mkdir -p /etc/canopy
cp ../../scripts/ccs-env.sh /etc/canopy
../../scripts/create-canopy-group-user.sh
id: canopy: no such user
Adding group `canopy' (GID 114) ...
Done.
id: canopy: no such user
Adding system user `canopy' (UID 108) ...
Adding new user `canopy' (UID 108) with group `canopy' ...
Not creating home directory `/home/canopy'.
mkdir -p /var/log/canopy
touch /var/log/canopy/ccs.log
touch /var/log/canopy/ccs-errors.log
chown canopy /var/log/canopy
chgrp canopy /var/log/canopy
chown canopy /var/log/canopy/ccs.log
chgrp canopy /var/log/canopy/ccs.log
chown canopy /var/log/canopy/ccs-errors.log
chgrp canopy /var/log/canopy/ccs-errors.log
make[1]: Leaving directory `/home/ubuntu/canopy-cloud/src/canopy'</pre>
        
            </div>
        </div>
    
            </div>
        </div>
    
    
        <div class=hammock-section-outer>
            <a class=hammock-a-name id=configuring_and_running name=configuring_and_running></a>
            <div class=hammock-section-title>
                Configuring and Running
            </div>
            <div class=hammock-section-contents>
                
        
        <div class=hammock-subsection-outer>
            <div class=hammock-subsection-title>
                Configuring the Cloud Server
            </div>
            <div class=hammock-subsection-contents>
                
            One last step before running the Canopy Server.  We must configure it.
            Edit the file: 
            <pre class='hammock-code'>/etc/canopy/server.conf</pre>
            <p>
                Change the <span class=hammock-icode>"hostname"</span> to match the IP address or hostname of your server.
            </p>
            <p>
                There a many other configuration options you can modify.  Learn
                more about configuring the server in the <a href=#configuration>C<!---->o<!---->n<!---->f<!---->i<!---->g<!---->u<!---->r<!---->a<!---->t<!---->i<!---->o<!---->n<!----></a> chapter.
            </p>
        
            </div>
        </div>

        
        <div class=hammock-subsection-outer>
            <div class=hammock-subsection-title>
                Starting Cassandra and Initialize Database
            </div>
            <div class=hammock-subsection-contents>
                
            <p>
                Start Cassandra running:
            </p>
            <pre class='hammock-code'>sudo cassandra</pre>
            <p>
                You should see a bunch of text scroll, ending with:
            </p>
            <pre class='hammock-output'>INFO 17:24:59,576 Completed flushing /var/lib/cassandra/data/system/local/system-local-jb-3-Data.db (114 bytes) for commitlog position ReplayPosition(segmentId=1410197098396, position=91604)
INFO 17:24:59,644 CFS(Keyspace='system', ColumnFamily='local') liveRatio is 27.44988344988345 (just-counted was 3.515151515151515).  calculation took 5ms for 257 cells
INFO 17:24:59,644 Enqueuing flush of Memtable-local@414544706(10098/277188 serialized/live bytes, 259 ops)
INFO 17:24:59,645 Writing Memtable-local@414544706(10098/277188 serialized/live bytes, 259 ops)
INFO 17:24:59,677 Completed flushing /var/lib/cassandra/data/system/local/system-local-jb-4-Data.db (5275 bytes) for commitlog position ReplayPosition(segmentId=1410197098396, position=103603)
INFO 17:24:59,693 Compacting [SSTableReader(path='/var/lib/cassandra/data/system/local/system-local-jb-1-Data.db'), SSTableReader(path='/var/lib/cassandra/data/system/local/system-local-jb-3-Data.db'), SSTableReader(path='/var/lib/cassandra/data/system/local/system-local-jb-4-Data.db'), SSTableReader(path='/var/lib/cassandra/data/system/local/system-local-jb-2-Data.db')]
INFO 17:24:59,780 Node localhost/127.0.0.1 state jump to normal</pre>
            <p>
                Press ENTER to return to the command-line.
            </p>
            <p>
                Create the database:
            </p>
            <pre class='hammock-code'>canopy-ops create-db</pre>
        
            </div>
        </div>

        
        <div class=hammock-subsection-outer>
            <div class=hammock-subsection-title>
                Starting the Canopy Server
            </div>
            <div class=hammock-subsection-contents>
                
            <p>
                Now, you can start the Canopy Server
            </p>
            <pre class='hammock-code'>sudo /etc/init.d/canopy-server start</pre>

            <p>
                To check that it is working, go to
                <span class=hammock-icode>https://&lt;ip_address&gt;/api/info</span> in your web
                browser.  You should see something like the following response:
            </p>
            <pre class='hammock-output'>{
    "clock_us": 1427847182641191,
    "clock_utc": "2015-04-01T00:13:02.641191Z",
    "config": {
        "allow-anon-devices": true,
        "allow-origin": "",
        "email-service": "sendgrid",
        "enable-http": false,
        "enable-https": true,
        "forward-other-hosts": "",
        "hostname": "dev02.canopy.link",
        "http-port": 80,
        "https-cert-file": "/etc/canopy/cert.pem",
        "https-port": 443,
        "https-priv-key-file": "/etc/canopy/key.pem",
        "js-client-path": "/home/gregp/development/canopy/canopy-js-client",
        "log-file": "/var/log/canopy/server.log",
        "sendgrid-username": "canopy-mailer",
        "web-manager-path": "/home/gregp/development/canopy/canopy-app"
    },
    "result": "ok",
    "service-name": "Canopy Cloud Service",
    "version": "15.04.03"
}</pre>
            <p>
                If you see anything other than that, there was most likely a
                problem.  You can view the log file by typing:
            </p>

            <pre class='hammock-code'>cat /var/log/canopy/server.log</pre>
        
            </div>
        </div>
    
            </div>
        </div>

                </div>
            </div>


            <div class=hammock-chapter-outer>
                <a class=hammock-a-name id=configuration name=configuration></a>
                <div class=hammock-chapter-title>
                    Configuration
                </div>
                <div class=hammock-chapter-contents>
                    
    
        <div class=hammock-section-outer>
            <a class=hammock-a-name id=config_priority name=config_priority></a>
            <div class=hammock-section-title>
                Config Priority
            </div>
            <div class=hammock-section-contents>
                
        <p>
            The Canopy Server's configuration is read from one or more config
            files.  Config settings can be overridden with environment
            variables and command-line parameters.
        </p>
        <p>
            This table shows the ordering in which configuration is read:
        </p>
        <table cellspacing=0 cellpadding=0 border=0 class=hammock-tbl>
            <tr>
                <td  class=hammock-tbl-header>
                    Config Source
                </td>
                <td  class=hammock-tbl-header>
                    Order
                </td>
            </tr>
            <tr>
                <td ><span class=hammock-icode>Compiled Defaults</span></td>
                <td >1 - Lowest priority (read first)</td>
            </tr>
            <tr>
                <td ><span class=hammock-icode>/etc/canopy/server.conf</span></td>
                <td >2</td>
            </tr>
            <tr>
                <td ><span class=hammock-icode>$HOME/.canopy/server.conf</span></td>
                <td >3</td>
            </tr>
            <tr>
                <td ><span class=hammock-icode>$CANOPY_SERVER_CONFIG_FILE</span></td>
                <td >4</td>
            </tr>
            <tr>
                <td ><span class=hammock-icode>Environment Variables</span></td>
                <td >5</td>
            </tr>
            <tr>
                <td ><span class=hammock-icode>Command-line Parameters</span></td>
                <td >6 - Highest priority (read last)</td>
            </tr>
        </table>
    
            </div>
        </div>
    
        <div class=hammock-section-outer>
            <a class=hammock-a-name id=configuration_settings name=configuration_settings></a>
            <div class=hammock-section-title>
                Configuration Settings
            </div>
            <div class=hammock-section-contents>
                
        <table cellspacing=0 cellpadding=0 border=0 class=hammock-tbl>
            <tr>
                <td  class=hammock-tbl-header>
                    JSON Key
                </td>
                <td  class=hammock-tbl-header>
                    Environment Variable
                </td>
                <td  class=hammock-tbl-header>
                    Command-line Option
                </td>
                <td  class=hammock-tbl-header>
                    Description
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"allow-anon-devices"</span></td>
                <td nowrap><span class=hammock-icode>ALLOW_ANON_DEVICES</span></td>
                <td nowrap><span class=hammock-icode>--allow-anon-devices=</span></td>
                <td >
                    If <span class=hammock-icode>true</span>, allow anonymous devices to post
                    data to the server.  If <span class=hammock-icode>false</span>, require that
                    every device has an associated User Account.
                    <p>
                        <b>Default:</b> <span class=hammock-icode>true</span>
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"allow-origin"</span></td>
                <td nowrap><span class=hammock-icode>CCS_ALLOW_ORIGIN</span></td>
                <td nowrap><span class=hammock-icode>--allow-origin=</span></td>
                <td >
                    Domains to include in the "allow-origin" header of HTTP
                    responses.
                    <p>
                        <b>Default:</b> <span class=hammock-icode>""</span>
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"email-service"</span></td>
                <td nowrap><span class=hammock-icode>CCS_EMAIL_SERVICE</span></td>
                <td nowrap><span class=hammock-icode>--email-service=</span></td>
                <td >
                    Selects external service to use for sending email.  Valid
                    options are:
                    <ul><li><span class=hammock-icode>"none"</span> - Do not send email.</li>
                        <li><span class=hammock-icode>"sendgrid"</span> - Use SendGrid to send email.</li>
                    </ul>
                    If <span class=hammock-icode>"sendgrid"</span>, then you must also set
                    <span class=hammock-icode>"sendgrid-username"</span> and
                    <span class=hammock-icode>"sendgrid-secret-key"</span>.
                    <p>
                        <b>Default:</b> <span class=hammock-icode>"none"</span>
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"enable-http"</span></td>
                <td nowrap><span class=hammock-icode>CCS_ENABLE_HTTP</span></td>
                <td nowrap><span class=hammock-icode>--enable-http=</span></td>
                <td >
                    Serve the Canopy REST API over HTTP.
                    <p>
                        <b>Warning:</b> Enabling this option makes Canopy
                        vulnerable to a number of attacks, including password
                        snooping, man-in-the-middle attacks, and more.  This
                        option should only be used if Canopy is deployed on a
                        secured LAN and you know what you're doing!
                    </p>
                    <p>
                        <b>Default:</b> <span class=hammock-icode>false</span>
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"enable-https"</span></td>
                <td nowrap><span class=hammock-icode>CCS_ENABLE_HTTPS</span></td>
                <td nowrap><span class=hammock-icode>--enable-https=</span></td>
                <td >
                    Serve the Canopy REST API over HTTPS.
                    <p>
                        <b>Default:</b> <span class=hammock-icode>true</span>
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"forward-other-hosts"</span></td>
                <td nowrap><span class=hammock-icode>CCS_FORWARD_OTHER_HOSTS</span></td>
                <td nowrap><span class=hammock-icode>--forward-other-hosts=</span></td>
                <td >
                    The Canopy Server includes a proxy server that forwards
                    along all HTTP requests to other hostnames.  This specifies
                    the destination URL for these requests.  If
                    <span class=hammock-icode>""</span> then forwarding will be disabled.
                    <p>
                        <b>Default:</b> <span class=hammock-icode>""</span>.
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"hostname"</span></td>
                <td nowrap><span class=hammock-icode>CCS_HOSTNAME</span></td>
                <td nowrap><span class=hammock-icode>--hostname=</span></td>
                <td >
                    Virtual hostname for Canopy Server.  This option is
                    required.  HTTP requests to other hosts will be forwarded
                    to the <span class=hammock-icode>"forward-other-hosts"</span>.
                    <p>
                        <b>Default:</b> <span class=hammock-icode>""</span>.
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"http-port"</span></td>
                <td nowrap><span class=hammock-icode>CCS_HTTP_PORT</span></td>
                <td nowrap><span class=hammock-icode>--http-port=</span></td>
                <td >
                    HTTP port to listen on.
                    <p>
                        <b>Default:</b> <span class=hammock-icode>80</span>.
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"https-cert-file"</span></td>
                <td nowrap><span class=hammock-icode>CCS_HTTPS_CERT_FILE</span></td>
                <td nowrap><span class=hammock-icode>--https-cert-file=</span></td>
                <td >
                    Filename of HTTPS certificate file on local file system.
                    For example: <span class=hammock-icode>"/etc/canopy/cert.pem"</span>.
                    This is mandatory if <span class=hammock-icode>"enable-https"</span> is
                    <span class=hammock-icode>true</span>.
                    <p>
                        <b>Default:</b> <span class=hammock-icode>""</span>.
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"https-port"</span></td>
                <td nowrap><span class=hammock-icode>CCS_HTTPS_PORT</span></td>
                <td nowrap><span class=hammock-icode>--https-port=</span></td>
                <td >
                    HTTPS port to listen on.
                    <p>
                        <b>Default:</b> <span class=hammock-icode>443</span>.
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"https-priv-key-file"</span></td>
                <td nowrap><span class=hammock-icode>CCS_HTTPS_PRIV_KEY_FILE</span></td>
                <td nowrap><span class=hammock-icode>--http-priv-key-file=</span></td>
                <td >
                    Filename of HTTPS private key file on local file system.
                    For example: <span class=hammock-icode>"/etc/canopy/key.pem"</span>.
                    This is mandatory if <span class=hammock-icode>"enable-https"</span> is
                    <span class=hammock-icode>true</span>.
                    <p>
                        <b>Default:</b> <span class=hammock-icode>""</span>.
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"js-client-path"</span></td>
                <td nowrap><span class=hammock-icode>CCS_JS_CLIENT_PATH</span></td>
                <td nowrap><span class=hammock-icode>--js-client-path=</span></td>
                <td >
                    Local filesystem path to the <span class=hammock-icode>canopy-js-client/</span>
                    project.
                    This must be configured to enable the Canopy Device
                    Manager.
                    <p>
                        <b>Default:</b> <span class=hammock-icode>""</span>.
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"log-file"</span></td>
                <td nowrap><span class=hammock-icode>CCS_LOG_FILE</span></td>
                <td nowrap><span class=hammock-icode>--log-file=</span></td>
                <td >
                    Location of log file on local filesystem.
                    <p>
                        <b>Default:</b> <span class=hammock-icode>"/var/log/canopy/canopy-server.log"</span>.
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"password-hash-cost"</span></td>
                <td nowrap><span class=hammock-icode>CCS_PASSWORD_HASH_COST</span></td>
                <td nowrap><span class=hammock-icode>--password-hash-cost=</span></td>
                <td >
                    Integer value between 4 and 31 specifying the bcrypt hash
                    cost for newly generated passwords.  Higher values result
                    in it taking longer to verify a user's password, making it
                    more difficult to perform a brute force attack.  However,
                    if this is too high then it will affect server
                    responsiveness and consume too many resources on the
                    server.
                    <p>
                        <b>Default:</b> <span class=hammock-icode>10</span>.
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"password-secret-salt"</span></td>
                <td nowrap><span class=hammock-icode>CCS_PASSWORD_SECRET_SALT</span></td>
                <td nowrap><span class=hammock-icode>--password-secret-salt=</span></td>
                <td >
                    Secure secret string that must not be made public and
                    should be different for every server.  This is used as
                    "salt" that is appended to passwords before they are
                    hashed.
                    <p>
                        <b>Warning:</b> Changing this value will cause
                        everyone's password to no longer work.
                    </p>
                    <p>
                        <b>Default:</b> <span class=hammock-icode>""</span>.
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"production-secret"</span></td>
                <td nowrap><span class=hammock-icode>CCS_PRODUCTION_SECRET</span></td>
                <td nowrap><span class=hammock-icode>--production-secret=</span></td>
                <td >
                    Secure secret string that must not be made public and
                    should be different for every server.  This is used to
                    secure session cookies.
                    <p>
                        <b>Default:</b> <span class=hammock-icode>""</span>.
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"sendgrid-secret-key"</span></td>
                <td nowrap><span class=hammock-icode>CCS_SENDGRID_SECRET_KEY</span></td>
                <td nowrap><span class=hammock-icode>--sendgrid-secret-key=</span></td>
                <td >
                    Secure secret key provided by SendGrid.  This must not be
                    made public and should be different for every server.  This
                    is required if <span class=hammock-icode>"email-service"</span> is
                    <span class=hammock-icode>"sendgrid"</span>.  Otherwise it is ignored.
                    <p>
                        <b>Default:</b> <span class=hammock-icode>""</span>.
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"sendgrid-username"</span></td>
                <td nowrap><span class=hammock-icode>CCS_SENDGRID_USERNAME</span></td>
                <td nowrap><span class=hammock-icode>--sendgrid-secret-key=</span></td>
                <td >
                    Username of SendGrid account, used for sending emails.
                    This is required if <span class=hammock-icode>"email-service"</span> is
                    <span class=hammock-icode>"sendgrid"</span>.  Otherwise it is ignored.
                    <p>
                        <b>Default:</b> <span class=hammock-icode>""</span>.
                    </p>
                </td>
            </tr>
            <tr>
                <td nowrap><span class=hammock-icode>"web-manager-path"</span></td>
                <td nowrap><span class=hammock-icode>CCS_WEB_MANAGER_PATH</span></td>
                <td nowrap><span class=hammock-icode>--web-manager-path=</span></td>
                <td >
                    Local filesystem path to the <span class=hammock-icode>canopy-app/</span>
                    project.
                    This must be configured to enable the Canopy Device
                    Manager.
                    <p>
                        <b>Default:</b> <span class=hammock-icode>""</span>.
                    </p>
                </td>
            </tr>
        </table>
    
            </div>
        </div>
    
        <div class=hammock-section-outer>
            <a class=hammock-a-name id=config_file_example name=config_file_example></a>
            <div class=hammock-section-title>
                Config File Example
            </div>
            <div class=hammock-section-contents>
                
        <pre class='hammock-code'>{
    "allow-anon-devices" : false,
    "allow-origin" : "sandbox.canopy.link myiotapp.com",
    "email-service" : "sendgrid",
    "enable-http" : false,
    "enable-https" : true,
    "forward-other-hosts" : "http://canopy.link",
    "http-port" : 80,
    "https-cert-file" : "/etc/canopy/cert.pem",
    "https-port" : 443,
    "https-priv-key-file" : "/etc/canopy/key.pem",
    "hostname" : "sandbox.canopy.link",
    "js-client-path" : "/home/ubuntu/canopy-js-client",
    "password-hash-cost" : 10,
    "password-secret-salt" : "E2vOmLYAig7ER5uIoL9wSa",
    "production-secret" : "my production secret",
    "sendgrid-secret-key" : "ljP)48-1x*CL@0iA#",
    "sendgrid-username" : "mysendgridusername",
    "web-manager-path" : "/home/ubuntu/canopy-app",
}</pre>
    
            </div>
        </div>
    
        <div class=hammock-section-outer>
            <a class=hammock-a-name id=environment_override_example name=environment_override_example></a>
            <div class=hammock-section-title>
                Environment Override Example
            </div>
            <div class=hammock-section-contents>
                
        For example, to run the Canopy Server as a non-root user, you might use:
        <pre class='hammock-code'>CCS_HTTPS_PORT=8443 CCS_LOG_FILE="ccs.log" /usr/local/bin/canopy-server</pre>
    
            </div>
        </div>
    
        <div class=hammock-section-outer>
            <a class=hammock-a-name id=command-line_override_example name=command-line_override_example></a>
            <div class=hammock-section-title>
                Command-line Override Example
            </div>
            <div class=hammock-section-contents>
                
        An alternative way to run the Canopy Server as a non-root user is:
        <pre class='hammock-code'>/usr/local/bin/canopy-server --https-port=8443 --log-file="ccs.log"</pre>
    
            </div>
        </div>
    
        <div class=hammock-section-outer>
            <a class=hammock-a-name id=checking_the_configuration name=checking_the_configuration></a>
            <div class=hammock-section-title>
                Checking the Configuration
            </div>
            <div class=hammock-section-contents>
                
        <p>
            You can check the configuration of a running Canopy Server using
            the <span class=hammock-icode>/api/info</span> endpoint.  For example:
        </p>
        <p>
            <a href="https://sandbox.canopy.link/api/info" target="_blank" ><b>https://sandbox.canopy.link/api/info</b></a>
        </p>
        <p>
            Additionally, the log file may contain a dump of all configuration
            settings (except passwords) when the server starts up:
        </p>
        <pre class='hammock-code'>tail -f /var/log/canopy-server.log</pre>
    
            </div>
        </div>
    
        <div class=hammock-section-outer>
            <a class=hammock-a-name id=ssl_setup_-_self-signed_certificate name=ssl_setup_-_self-signed_certificate></a>
            <div class=hammock-section-title>
                SSL Setup - Self-signed Certificate
            </div>
            <div class=hammock-section-contents>
                
        This command creates a 2048-bit private key (key.pem) and a self-signed
        certificate (cert.pem)
        <pre class='hammock-code'>openssl req -newkey rsa:2048 -nodes -keyout key.pem -x509 -days 365 -out cert.pem</pre>
        <p>
            Place these files somewhere secure on your server.  Perhaps:
        </p>
        <pre class='hammock-code'>sudo mv key.pem /etc/canopy/key.pem
sudo mv cert.pem /etc/canopy/cert.pem</pre>
        <p>
            Configure your <span class=hammock-icode>/etc/canopy/server.conf</span> file to point
            to these files:
        </p>
        <pre class='hammock-code'>"enable-https" : true,
"https-cert-file" : "/etc/canopy/cert.pem",
"https-priv-key-file" : "/etc/canopy/key.pem",</pre>
    
            </div>
        </div>
    
        <div class=hammock-section-outer>
            <a class=hammock-a-name id=ssl_setup_-_ca-signed_certificate name=ssl_setup_-_ca-signed_certificate></a>
            <div class=hammock-section-title>
                SSL Setup - CA-signed Certificate
            </div>
            <div class=hammock-section-contents>
                
        This command creates a Certificate Signing Request (csr.pem) and a
        2048-bit private key (key.pem).
        <pre class='hammock-code'>openssl req -newkey rsa:2048 -nodes -keyout key.pem -out csr.pem</pre>
        <p>
            Follow the instructions provided by your Certificate Authority of
            choice (such as VeriSign, GoDaddy, or Gandi.net) to convert this
            CSR into an SSL Certificate.
        </p>
        <p>
            Once you receive the certificate, copy the private key and
            certificate somewhere secure on your server, such as:
        </p>
        <pre class='hammock-code'>/etc/canopy/key.pem
/etc/canopy/cert.pem</pre>
        <p>
            Configure your <span class=hammock-icode>/etc/canopy/server.conf</span> file to point
            to these files:
        </p>
        <pre class='hammock-code'>"enable-https" : true,
"https-cert-file" : "/etc/canopy/cert.pem",
"https-priv-key-file" : "/etc/canopy/key.pem",</pre>
    
            </div>
        </div>

                </div>
            </div>


            <div class=hammock-chapter-outer>
                <a class=hammock-a-name id=the_canopy-ops_tool name=the_canopy-ops_tool></a>
                <div class=hammock-chapter-title>
                    The canopy-ops Tool
                </div>
                <div class=hammock-chapter-contents>
                    
    <p>
        The <span class=hammock-icode>canopy-ops</span> tool gets installed when you follow the
        <a href=#installation>I<!---->n<!---->s<!---->t<!---->a<!---->l<!---->l<!---->a<!---->t<!---->i<!---->o<!---->n<!----></a> instructions above.  Typically it can be found in the
        <span class=hammock-icode>/usr/local/bin/</span> directory.
    </p>
    <p>
        This tool supports a growing number of commands that are useful for
        operating a Canopy Server deployment.  Run <span class=hammock-icode>"canopy-ops
        help"</span> for the list of commands supported by your version of the
        tool.
    </p>
    <table cellspacing=0 cellpadding=0 border=0 class=hammock-tbl>
        <tr>
            <td  class=hammock-tbl-header>
                Command Line
            </td>
            <td  class=hammock-tbl-header>
                Description
            </td>
        </tr>
        <tr>
            <td >
                <span class=hammock-icode>canopy-ops help [&lt;topic_or_cmd&gt;]</span>
            </td>
            <td >
                Display general help or get help for a topic or command
            </td>
        </tr>
        <tr>
            <td >
                <span class=hammock-icode>canopy-ops create-db</span>
            </td>
            <td >
                Initialize database
            </td>
        </tr>
        <tr>
            <td >
                <span class=hammock-icode>canopy-ops erase-db</span>
            </td>
            <td >
                Wipe entire database
            </td>
        </tr>
        <tr>
            <td >
                <span class=hammock-icode>canopy-ops reset-db</span>
            </td>
            <td >
                Wipe entire db then initialize a new db
            </td>
        </tr>
        <tr>
            <td >
                <span class=hammock-icode>canopy-ops workers</span>
            </td>
            <td >
                List all registered canopy workers
            </td>
        </tr>
    </table>

                </div>
            </div>

</div>
    <script> 
        RenderFooter();
    </script>
</body>
</html>

